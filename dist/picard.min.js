/* PiCard
 * Copyright (c) 2013 Tim De Pauw <https://github.com/timdp/picard>
 * Released under the MIT License
 */
var PiCard={defaultOptions:{},locales:{},addLocale:function(t,a){PiCard.locales[t]=a,"locale"in PiCard.defaultOptions||(PiCard.defaultOptions.locale=t)},defineClass:function(t,a,e,i){return $.each(t,function(t,e){$.extend(a.prototype,e.prototype)}),$.extend(a.prototype,e),a.prototype.constructor=a,i&&$.extend(a,i),a}};PiCard.Configurable=PiCard.defineClass([],function(t){this.options=$.extend({},PiCard.defaultOptions,this.defaultOptions,t)}),PiCard.Localized=PiCard.defineClass([],function(t){this.locale=PiCard.locales[t]},{formatNumber:function(t){var a=this;t=""+t;for(var e=/^([0-9]+)([0-9]{3})$/,i=!0;i;)i=!1,t=t.replace(e,function(t,e,o){return i=!0,e+a.locale.thousandsSeparator+o});return t}}),PiCard.Chart=PiCard.defineClass([PiCard.Configurable,PiCard.Localized],function(t,a,e){PiCard.Configurable.call(this,e),PiCard.Localized.call(this,this.options.locale),this.container=t,this.data=a,this.initialize()},{defaultOptions:{axisWidth:1,plotPadding:10,labelMargin:10,plotMarkerSize:6,plotMarkerWidth:1,minPieRadius:2,maxPieRadius:20,startAngle:-90,clockwise:!0,drawAllPlotMarkers:!1,dotScale:"quad",legendFormat:"{0} ({1})",legendColorProperties:["color"],fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontSize:12,activeOpacity:1,inactiveOpacity:.2,axisColor:"#666",plotMarkerColor:"#999",axisLabelColor:"#666",pieColors:["#C90","#0C9","#90C","#9C0","#09C","#C09","#C00","#0C0","#00C","#099","#909","#990","#C66","#6C6","#66C","#999"],legendItemTag:"span",userColors:{},usersKey:".users"},initialize:function(){var t=this;t.determineUserNames(),t.calculateTotals(),t.determineMaximum(),t.setUserColors(),t.calculateMeasurements(),t.createPlotArea(),t.createPlots(),t.createAxes(),t.createLegend(),t.prepareContainer(),t.createStage(),t.container.trigger("ready.picard",[t])},determineUserNames:function(){var t=this;void 0!==t.options.usersKey&&t.options.usersKey in t.data?(t.users=t.data[t.options.usersKey],delete t.data[t.options.usersKey]):t.users=t.sortUserNames()},sortUserNames:function(){var t=this,a=[];return $.each(t.data,function(t){a.push(t)}),a.sort(),a},prepareContainer:function(){var t=this,a=t.container.attr("id")+"-chart";t.chartContainer=$("<div>").attr("class","picard-chart").attr("id",a),t.container.empty().append(t.legend).append(t.chartContainer)},createStage:function(){var t=this;t.stage=new Kinetic.Stage({container:t.chartContainer.attr("id"),width:t.measure.width,height:t.measure.height}),t.stage.add(t.plotArea),$.each(t.plots,function(a,e){t.stage.add(e)}),t.stage.add(t.axes)},createLegend:function(){var t=this,a={},e=0;$.each(t.data,function(t,i){var o=0;$.each(i,function(t,a){$.each(a,function(t,a){o+=a})}),a[t]=o,e+=o}),t.legend=$("<div/>").attr("class","picard-legend").append($("<span/>").attr("class","picard-legend-label").text(t.locale.summaryLabel+" "+t.formatNumber(e))),$.each(t.users,function(e,i){var o=[i,t.formatNumber(a[i])],n=t.options.legendFormat.replace(/\{([0-9]+)\}/g,function(t,a){return o[parseInt(a,10)]});t.legend.append(" ");var r={};$.each(t.options.legendColorProperties,function(a,e){r[e]=t.userColors[i]});var s=$("<"+t.options.legendItemTag+"/>").attr("class","picard-legend-item").css(r).html(n);s.mouseover({user:i,that:t,legendItem:s},t.setActive).mouseout({user:null,that:t,legendItem:s},t.setActive),t.legend.append(s)})},setActive:function(t){var a=t.data.user,e=t.data.that,i=t.data.legendItem;e.container.trigger("activate.picard",[e,i,a]),$.each(e.plots,function(t,i){e.setOpacity(i,null===a||a==t?e.options.activeOpacity:e.options.inactiveOpacity)}),e.setOpacity(e.plotArea,null===a?e.options.activeOpacity:e.options.inactiveOpacity)},setOpacity:function(t,a){t.getOpacity()!=a&&(t.setOpacity(a),t.draw())},createPlotArea:function(){var t=this;t.plotArea=new Kinetic.Layer;for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,e=t.options.plotPadding+t.options.maxPieRadius,i=t.options.plotMarkerSize/2,o=0;7>o;o++){for(var n=a,r=0;24>r;r++)(t.options.drawAllPlotMarkers||!t.totals[o][r])&&(t.plotArea.add(new Kinetic.Line({points:[n-i,e,n+i,e],stroke:t.options.plotMarkerColor,strokeWidth:t.options.plotMarkerWidth})),t.plotArea.add(new Kinetic.Line({points:[n,e-i,n,e+i],stroke:t.options.plotMarkerColor,strokeWidth:t.options.plotMarkerWidth}))),n+=2*t.options.maxPieRadius;e+=2*t.options.maxPieRadius}},createPlots:function(){var t=this;t.plots={},$.each(t.userColors,function(a){t.plots[a]=new Kinetic.Layer,t.plots[a].setOpacity(t.options.activeOpacity)});for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,e=t.options.plotPadding+t.options.maxPieRadius,i=0;7>i;i++){for(var o=a,n=0;24>n;n++)t.totals[i]&&t.totals[i][n]&&t.plotPie(i,n,o,e),o+=2*t.options.maxPieRadius;e+=2*t.options.maxPieRadius}},plotPie:function(t,a,e,i){var o=this,n=o.totals[t][a],r=o.getRatio(n);if(!(0>=r)){var s=Math.max(o.options.minPieRadius,r*o.options.maxPieRadius),l=null===o.options.startAngle?360*Math.random():o.options.startAngle;$.each(o.data,function(r,d){if(d[t]&&d[t][a]){var c=360*(d[t][a]/n),u=new Kinetic.Wedge({x:e,y:i,radius:s,rotationDeg:o.options.clockwise?l:360-l-c,angleDeg:c,fill:o.userColors[r]});o.plots[r].add(u),l+=c}})}},getRatio:function(t){var a=this;if(0>=t)return 0;var e="quad"==a.options.scale?Math.sqrt:"log"==a.options.scale?Math.log:function(t){return t};return e(t)/e(a.maximum)},createAxes:function(){var t=this;t.axes=new Kinetic.Layer,t.createXAxis(),t.createYAxis()},createXAxis:function(){var t=this;t.axes.add(new Kinetic.Line({points:[t.measure.yLabelWidth+t.options.labelMargin,t.measure.plotHeight+t.options.axisWidth/2,t.measure.width,t.measure.plotHeight+t.options.axisWidth/2],stroke:t.options.axisColor,strokeWidth:t.options.axisWidth}));for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,e=t.measure.plotHeight+t.options.axisWidth+t.options.labelMargin,i=0;24>i;i++){var o=t.createText(10>i?"0"+i:i,a,e,t.options.axisLabelColor);o.setOffset({x:o.getWidth()/2}),t.axes.add(o),a+=2*t.options.maxPieRadius}},createYAxis:function(){var t=this;t.axes.add(new Kinetic.Line({points:[t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth/2,0,t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth/2,t.measure.plotHeight+t.options.axisWidth],stroke:t.options.axisColor,strokeWidth:t.options.axisWidth}));for(var a=t.measure.yLabelWidth,e=t.options.plotPadding+t.options.maxPieRadius-t.measure.labelHeight/2,i=0;7>i;i++){var o=t.createText(t.locale.dayNames[i],a,e,t.options.axisLabelColor);o.setOffset({x:o.getWidth()}),t.axes.add(o),e+=2*t.options.maxPieRadius}},calculateTotals:function(){var t=this;t.totals=[];for(var a=0;7>a;a++){for(var e=[],i=0;24>i;i++)e[i]=0,$.each(t.data,function(t,o){o[a]&&o[a][i]&&(e[i]+=o[a][i])});t.totals[a]=e}},determineMaximum:function(){var t=this;t.maximum=0;for(var a=0;7>a;a++)for(var e=0;24>e;e++)t.totals[a]&&t.totals[a][e]&&(t.maximum=Math.max(t.maximum,t.totals[a][e]))},setUserColors:function(){var t=this;t.userColors={};var a=0,e=t.options.pieColors.length;$.each(t.users,function(i,o){t.userColors[o]=t.options.userColors[o]||t.options.pieColors[a++%e]})},calculateMeasurements:function(){for(var t=this,a=0,e=0;7>e;e++){var i=t.createText(t.locale.dayNames[e],0,0,"black");a=Math.max(a,i.getWidth())}var o=t.createText("X",0,0,"black").getHeight(),n=t.options.plotPadding+24*2*t.options.maxPieRadius+t.options.plotPadding,r=t.options.plotPadding+7*2*t.options.maxPieRadius+t.options.plotPadding,s=a+t.options.labelMargin+t.options.axisWidth+n,l=r+t.options.axisWidth+t.options.labelMargin+o;t.measure={width:s,height:l,plotWidth:n,plotHeight:r,yLabelWidth:a,labelHeight:o}},createText:function(t,a,e,i){var o=this;return new Kinetic.Text({text:t,fontFamily:o.options.fontFamily,fontSize:o.options.fontSize,fill:i,x:a,y:e})}}),PiCard.View=PiCard.defineClass([PiCard.Configurable,PiCard.Localized],function(t,a){this.container=t,PiCard.Configurable.call(this,a),PiCard.Localized.call(this,this.options.locale)}),PiCard.View.Single=PiCard.defineClass([PiCard.View],function(t,a,e){PiCard.View.call(this,t,e),this.url=a,this.initialize()},{initialize:function(){var t=this;$.ajax(t.url).done(function(a){new PiCard.Chart(t.container,a,t.options)}).fail(function(a,e,i){t.container.text(t.locale.loadingFailedText),t.container.trigger("picard.loadingFailed",[t,a,e,i,t.container,t.url])})}}),PiCard.View.Tabbed=PiCard.defineClass([PiCard.View],function(t,a,e){PiCard.View.call(this,t,e),this.sources=a,this.initialize()},{defaultOptions:{includeSummary:!0,linkSummaryLegendItems:!0},initialize:function(){var t=this,a=[];t.container.empty(),t.tabList=$("<ul/>"),t.container.append(t.tabList),t.options.includeSummary&&(t.summaryTab=t.addTab(t.locale.summaryTitle,!0),t.summaryTab.addClass("picard-tab-summary")),$.each(t.sources,function(e,i){var o=i.name,n=t.addTab(o);a.push({name:o,url:i.url,target:n})}),t.container.tabs();var e=[];t.processQueue(a,e)},addTab:function(t){var a=this,e="picard-tab-"+PiCard.View.Tabbed.tabCount++;a.tabList.append($("<li/>").append($("<a/>").attr("href","#"+e).text(t)));var i=$("<div/>").attr("id",e).addClass("picard-tab").text(a.locale.loadingText);return a.container.append(i),i},processQueue:function(t,a){if(0!=t.length){var e=this,i=t.shift();$.ajax(i.url).done(function(t){a.push({name:i.name,target:i.target,data:t})}).fail(function(t,a,o){i.target.text(e.locale.loadingFailedText),e.container.trigger("picard.loadingFailed",[e,t,a,o,i.target,i.url,i.name])}).always(function(){0==t.length?e.buildCharts(a):e.processQueue(t,a)})}},buildCharts:function(t){var a=this;if(a.options.includeSummary){var e={};$.each(t,function(t,i){a.updateSummary(i.name,i.data,e)}),setTimeout(function(){var t=a.summaryTab,i=a.options.linkSummaryLegendItems?$.extend({legendItemTag:"a"},a.options):a.options;new PiCard.Chart(t,e,i),a.options.linkSummaryLegendItems&&a.linkSummaryLegendItems(t)},0)}$.each(t,function(t,e){setTimeout(function(){new PiCard.Chart(e.target,e.data,a.options)},0)})},linkSummaryLegendItems:function(t){var a=this.container.find(".ui-tabs-anchor");t.find(".picard-legend-item").each(function(t,e){var i=a[t+1];$(e).click(function(){i.click()})})},updateSummary:function(t,a,e){e[t]={};for(var i=0;7>i;i++){for(var o={},n=0;24>n;n++)o[n]=0;e[t][i]=o}$.each(a,function(a,i){$.each(i,function(a,i){$.each(i,function(i,o){e[t][a][i]+=o})})})}},{tabCount:0}),PiCard.addLocale("en-US",{dayNames:["MON","TUE","WED","THU","FRI","SAT","SUN"],summaryTitle:"Summary",summaryLabel:"Commits:",loadingText:"Loading …",loadingFailedText:"Failed to load data. Reload to try again.",thousandsSeparator:","});