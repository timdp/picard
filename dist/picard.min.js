/* PiCard
 * Copyright (c) 2013 Tim De Pauw <https://github.com/timdp/picard>
 * Released under the MIT License
 */
var PiCard={defaultOptions:{},locales:{},addLocale:function(t,a){PiCard.locales[t]=a,"locale"in PiCard.defaultOptions||(PiCard.defaultOptions.locale=t)},defineClass:function(t,a,i){return $.each(t,function(t,i){$.extend(a.prototype,i.prototype)}),$.extend(a.prototype,i),a.prototype.constructor=a,a}};PiCard.Configurable=PiCard.defineClass([],function(t){this.options=$.extend({},PiCard.defaultOptions,this.defaultOptions,t)}),PiCard.Localized=PiCard.defineClass([],function(t){this.locale=PiCard.locales[t]},{formatNumber:function(t){var a=this;t=""+t;for(var i=/^([0-9]+)([0-9]{3})$/,e=!0;e;)e=!1,t=t.replace(i,function(t,i,o){return e=!0,i+a.locale.thousandsSeparator+o});return t}}),PiCard.Chart=PiCard.defineClass([PiCard.Configurable,PiCard.Localized],function(t,a,i){PiCard.Configurable.call(this,i),PiCard.Localized.call(this,this.options.locale),this.container=t,this.data=a,this.initialize()},{defaultOptions:{axisWidth:1,plotPadding:10,labelMargin:10,plotMarkerSize:6,plotMarkerWidth:1,minPieRadius:2,maxPieRadius:20,startAngle:-90,clockwise:!0,drawAllPlotMarkers:!1,dotScale:"quad",legendFormat:"{0} ({1})",fontFamily:"Verdana, Arial, Helvetica, sans-serif",fontSize:12,activeOpacity:1,inactiveOpacity:.2,axisColor:"#666",plotMarkerColor:"#999",axisLabelColor:"#666",pieColors:["#C90","#0C9","#90C","#9C0","#09C","#C09","#C00","#0C0","#00C","#099","#909","#990","#C66","#6C6","#66C","#999"],usersKey:".users"},initialize:function(){var t=this;t.determineUserNames(),t.calculateTotals(),t.determineMaximum(),t.setUserColors(),t.calculateMeasurements(),t.createPlotArea(),t.createPlots(),t.createAxes(),t.createLegend(),t.prepareContainer(),t.createStage(),t.container.trigger("picard.ready",[t])},determineUserNames:function(){var t=this;void 0!==t.options.usersKey&&t.options.usersKey in t.data?(t.users=t.data[t.options.usersKey],delete t.data[t.options.usersKey]):t.users=t.sortUserNames()},sortUserNames:function(){var t=this,a=[];return $.each(t.data,function(t){a.push(t)}),a.sort(),a},prepareContainer:function(){var t=this,a=t.container.attr("id")+"-chart";t.chartContainer=$("<div>").attr("id",a),t.container.empty().append(t.legend).append(t.chartContainer)},createStage:function(){var t=this;t.stage=new Kinetic.Stage({container:t.chartContainer.attr("id"),width:t.measure.width,height:t.measure.height}),t.stage.add(t.plotArea),$.each(t.plots,function(a,i){t.stage.add(i)}),t.stage.add(t.axes)},createLegend:function(){var t=this,a={},i=0;$.each(t.data,function(t,e){var o=0;$.each(e,function(t,a){$.each(a,function(t,a){o+=a})}),a[t]=o,i+=o}),t.legend=$("<div/>").attr("class","picard-legend").append($("<span/>").attr("class","picard-legend-label").text(t.locale.summaryLabel+" "+t.formatNumber(i))),$.each(t.users,function(i,e){var o=[e,t.formatNumber(a[e])],n=t.options.legendFormat.replace(/\{([0-9]+)\}/g,function(t,a){return o[parseInt(a,10)]});t.legend.append(" "),t.legend.append($("<span>").attr("class","picard-legend-item").css("color",t.userColors[e]).mouseover({user:e,that:t},t.setActive).mouseout({user:null,that:t},t.setActive).html(n))})},setActive:function(t){var a=t.data.user,i=t.data.that;i.container.trigger("picard.activate",[i,a]),$.each(i.plots,function(t,e){i.setOpacity(e,null===a||a==t?i.options.activeOpacity:i.options.inactiveOpacity)}),i.setOpacity(i.plotArea,null===a?i.options.activeOpacity:i.options.inactiveOpacity)},setOpacity:function(t,a){t.getOpacity()!=a&&(t.setOpacity(a),t.draw())},createPlotArea:function(){var t=this;t.plotArea=new Kinetic.Layer;for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,i=t.options.plotPadding+t.options.maxPieRadius,e=t.options.plotMarkerSize/2,o=0;7>o;o++){for(var n=a,r=0;24>r;r++)(t.options.drawAllPlotMarkers||!t.totals[o][r])&&(t.plotArea.add(new Kinetic.Line({points:[n-e,i,n+e,i],stroke:t.options.plotMarkerColor,strokeWidth:t.options.plotMarkerWidth})),t.plotArea.add(new Kinetic.Line({points:[n,i-e,n,i+e],stroke:t.options.plotMarkerColor,strokeWidth:t.options.plotMarkerWidth}))),n+=2*t.options.maxPieRadius;i+=2*t.options.maxPieRadius}},createPlots:function(){var t=this;t.plots={},$.each(t.userColors,function(a){t.plots[a]=new Kinetic.Layer,t.plots[a].setOpacity(t.options.activeOpacity)});for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,i=t.options.plotPadding+t.options.maxPieRadius,e=0;7>e;e++){for(var o=a,n=0;24>n;n++)t.totals[e]&&t.totals[e][n]&&t.plotPie(e,n,o,i),o+=2*t.options.maxPieRadius;i+=2*t.options.maxPieRadius}},plotPie:function(t,a,i,e){var o=this,n=o.totals[t][a],r=o.getRatio(n);if(!(0>=r)){var s=Math.max(o.options.minPieRadius,r*o.options.maxPieRadius),l=null===o.options.startAngle?360*Math.random():o.options.startAngle;$.each(o.data,function(r,d){if(d[t]&&d[t][a]){var c=360*(d[t][a]/n);o.options.clockWise&&(c=-c);var p=new Kinetic.Wedge({x:i,y:e,radius:s,rotationDeg:l,angleDeg:c,fill:o.userColors[r]});o.plots[r].add(p),l+=c}})}},getRatio:function(t){var a=this;if(0>=t)return 0;var i="quad"==a.options.scale?Math.sqrt:"log"==a.options.scale?Math.log:function(t){return t};return i(t)/i(a.maximum)},createAxes:function(){var t=this;t.axes=new Kinetic.Layer,t.createXAxis(),t.createYAxis()},createXAxis:function(){var t=this;t.axes.add(new Kinetic.Line({points:[t.measure.yLabelWidth+t.options.labelMargin,t.measure.plotHeight+t.options.axisWidth/2,t.measure.width,t.measure.plotHeight+t.options.axisWidth/2],stroke:t.options.axisColor,strokeWidth:t.options.axisWidth}));for(var a=t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth+t.options.plotPadding+t.options.maxPieRadius,i=t.measure.plotHeight+t.options.axisWidth+t.options.labelMargin,e=0;24>e;e++){var o=t.createText(10>e?"0"+e:e,a,i,t.options.axisLabelColor);o.setOffset({x:o.getWidth()/2}),t.axes.add(o),a+=2*t.options.maxPieRadius}},createYAxis:function(){var t=this;t.axes.add(new Kinetic.Line({points:[t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth/2,0,t.measure.yLabelWidth+t.options.labelMargin+t.options.axisWidth/2,t.measure.plotHeight+t.options.axisWidth],stroke:t.options.axisColor,strokeWidth:t.options.axisWidth}));for(var a=t.measure.yLabelWidth,i=t.options.plotPadding+t.options.maxPieRadius-t.measure.labelHeight/2,e=0;7>e;e++){var o=t.createText(t.locale.dayNames[e],a,i,t.options.axisLabelColor);o.setOffset({x:o.getWidth()}),t.axes.add(o),i+=2*t.options.maxPieRadius}},calculateTotals:function(){var t=this;t.totals=[];for(var a=0;7>a;a++){for(var i=[],e=0;24>e;e++)i[e]=0,$.each(t.data,function(t,o){o[a]&&o[a][e]&&(i[e]+=o[a][e])});t.totals[a]=i}},determineMaximum:function(){var t=this;t.maximum=0;for(var a=0;7>a;a++)for(var i=0;24>i;i++)t.totals[a]&&t.totals[a][i]&&(t.maximum=Math.max(t.maximum,t.totals[a][i]))},setUserColors:function(){var t=this;t.userColors={},$.each(t.users,function(a,i){t.userColors[i]=t.options.pieColors[a%t.options.pieColors.length]})},calculateMeasurements:function(){for(var t=this,a=0,i=0;7>i;i++){var e=t.createText(t.locale.dayNames[i],0,0,"black");a=Math.max(a,e.getWidth())}var o=t.createText("X",0,0,"black").getHeight(),n=t.options.plotPadding+24*2*t.options.maxPieRadius+t.options.plotPadding,r=t.options.plotPadding+7*2*t.options.maxPieRadius+t.options.plotPadding,s=a+t.options.labelMargin+t.options.axisWidth+n,l=r+t.options.axisWidth+t.options.labelMargin+o;t.measure={width:s,height:l,plotWidth:n,plotHeight:r,yLabelWidth:a,labelHeight:o}},createText:function(t,a,i,e){var o=this;return new Kinetic.Text({text:t,fontFamily:o.options.fontFamily,fontSize:o.options.fontSize,fill:e,x:a,y:i})}}),PiCard.View=PiCard.defineClass([PiCard.Configurable,PiCard.Localized],function(t,a){this.container=t,PiCard.Configurable.call(this,a),PiCard.Localized.call(this,this.options.locale)}),PiCard.View.Single=PiCard.defineClass([PiCard.View],function(t,a,i){PiCard.View.call(this,t,i),this.url=a,this.initialize()},{initialize:function(){var t=this;$.ajax(t.url).done(function(a){new PiCard.Chart(t.container,a,t.options)}).fail(function(a,i,e){t.container.text(t.locale.loadingFailedText),t.container.trigger("picard.loadingFailed",[t,a,i,e,t.container,t.url])})}}),PiCard.View.Tabbed=PiCard.defineClass([PiCard.View],function(t,a,i){PiCard.View.call(this,t,i),this.sources=a,this.initialize()},{initialize:function(){var t=this,a=[];t.container.empty(),t.tabList=$("<ul/>"),t.container.append(t.tabList);var i="picard-tab-summary";t.addTab(t.locale.summaryTitle,i),$.each(t.sources,function(i,e){var o=e.name,n="picard-tab-"+i,r=t.addTab(o,n);a.push({name:o,url:e.url,target:r})}),t.container.tabs();var e={};t.processQueue(a,e)},addTab:function(t,a){var i=this;i.tabList.append($("<li/>").append($("<a/>").attr("href","#"+a).text(t)));var e=$("<div/>").attr("id",a).addClass("picard-tab").text(i.locale.loadingText);return i.container.append(e),e},processQueue:function(t,a){var i=this;if(t.length){var e=t.shift();$.ajax(e.url).done(function(t){new PiCard.Chart(e.target,t,i.options),i.updateSummary(e.name,t,a)}).fail(function(t,a,o){e.target.text(i.locale.loadingFailedText),i.container.trigger("picard.loadingFailed",[i,t,a,o,e.target,e.url,e.name])}).always(function(){i.processQueue(t,a)})}else new PiCard.Chart($("#picard-tab-summary"),a,i.options)},updateSummary:function(t,a,i){i[t]={};for(var e=0;7>e;e++){for(var o={},n=0;24>n;n++)o[n]=0;i[t][e]=o}$.each(a,function(a,e){$.each(e,function(a,e){$.each(e,function(e,o){i[t][a][e]+=o})})})}}),PiCard.addLocale("en-US",{dayNames:["MON","TUE","WED","THU","FRI","SAT","SUN"],summaryTitle:"Summary",summaryLabel:"Commits:",loadingText:"Loading â€¦",loadingFailedText:"Failed to load data. Reload to try again.",thousandsSeparator:","});